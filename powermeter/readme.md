Energy meter & monitor v2.1
===========================

<h1 align="center">
Счетчик электроэнергии и энергомонитор для IoT v2.1
</h1>
  
![Power meter](https://github.com/VladimirBakum/esp8266/blob/master/powermeter/picture/pm_rev1_1.png)

---

От идеи к готовому прибору... Закончен проект счетчика электроэнергии и энергомонитор для интернета вещей. <a href="https://thingspeak.com/channels/995558">Страница проекта.</a>

Да, я знаю, что исходный код на Lua не идеален с точки зрения локальных и глобальных переменных, эстетам не понравится. Но учтите то, что я не программист, учусь и делаю все по наитию. Тем не менее, за последние полтора года прибор работает стабильно. Раньше почему-то сбивались показания часов после долгой работы (дата в время в нулях), сейчас же такого глюка не наблюдаю. Оптимизировать код можно, другое дело - будет ли у меня на это время.

В разработке применен однофазный модуль энергомонитора <a href="https://aliexpress.ru/item/4000558302474.html">PZEM004T</a> v3 с передачей данных по протоколу modbus. 
Датчик - разъемный трансформатор тока. 
Диапазон измерения напряжений 80...260 В с точностью 0,1 В, относительная погрешность измерения 0,5%. 
Диапазон измерения переменного тока 0...100 А с точностью 0,01 А, относительная погрешность 0,5%. 
Диапазон измерения активной мощности 0...23 кВт с точностью 0,1 Вт, относительная погрешность 0,5%. 
Измерение коэффициента мощности 0...1 с точностью 0,01 и относительной погрешностью 1%. 
Измерение частоты питающей сети 45...65 Гц (в проекте не используется). 
Измерение активной энергии до 10 МВт*ч с точностью 1 Вт, относительной погрешностью 0,5%, с возможностью сброса накопленного показания от кнопки управления. 
Накопленное значение энергии хранится в энергонезависимой памяти прибора. В прибор добавлен термометр DS18B20 с диапазоном температур -40...+125 градусов Цельсия. 
Программа написана на языке Lua под платформу NodeMCU для ESP8266. 

В планах - отправка на email значения энергии каждое 1 число месяца, для удобства съема показаний (пока что есть ограничения по памяти). Update: позже планы оповещения отпали т.к. эта малозначительная функция сильно усложняет код.

Первая версия прототипа имела небольшой ч/б OLED дисплей для отображения текущих показаний энергомонитора. Сложность была в основном с UART-ом. Ранее я уже переключал UART в проекте обратного геопозиционирования с GPS, но там не было периферии и альтернативные ноги второго UART-а были доступны. В этом проекте использование ног контроллера практически под завязку. Пришлось применить "старый добрый" способ переключения UART-а на дешевом аналоговом мультиплексоре 74HC4053D (аналог CD4053).

В финальной версии применен удобный, контрастный, цветной OLED с быстрым SPI интерфейсом и большим разрешением. Также добавлен 7-сегментный индикатор на классическом MAX7219, позволяющем видеть издалека необходимое значение, выбранное единственнной сенсорной управляющей кнопкой. Плата помещена в корпус с прозрачной крышкой, что улучшает пыле-влагозащищенность. В моей единственной версии прибора модуль PZEM004T находится снаружи и подключен к плате четырехпроводным шлейфом небольой длинны. Место в корпусе есть (на дне), но его немного не хватило для того, чтобы поместить модуль внутрь. Разводка питания двух отдельных модулей при этом не очень удобна. Вчера снял пластиковый корпус с модуля PZEM004T и примерял его в корпусе прибора - если удалить интерфейсный разъем и на 3 мм укоротить плату, то всё помещается. Таким образом, можно сделать совершенно компактный прибор. Есть идея на его основе сделать очередной <a href="https://thingspeak.com/channels/172216">умный холодильник</a>.

Данные передаются на сайт <a href="https://thingspeak.com">Thingspeak</a> с возможностью дальнейшей статистической и математической обработки данных средствами <a href="https://www.mathworks.com/">MathWorks</a>. Для отображения текущих значений на смартфоне в виде виджета используется бесплатное приложение ThingDroid.

Сенорная кнопка имеет несколько функций:
1) Выбор режима прошивки контроллера (удержание кнопки сразу после подачи питания или сброса);
2) Настройка точки доступа (после включения прибора и отображения информации, нужно сразу приконуться к сенсору и изменить значение на индикаторе, отличное от единицы);
3) В основном режиме работы прибора кнопкой выбирается отображание текущей измеряемой величины на 7-сегментном индикаторе (последний пункт - сброс счетчика энергии).

Прибор можно использовать и без <a href="https://aliexpress.ru/item/4000136106619.html">OLED</a> ($13 на момент покупки), что сильно удешевляет всю конструкцию.

Работа над прибором продолжается. В основном, нужно доработать софт для более удобной и гибкой настройки прибора из web панели.

Кроме исходного кода планируется выложить схему и Gerber файлы печатной платы. But, it's a matter of time.

P.S. Надо отметить, что за последние полтора года модуль PZEM004T сильно подешевел (было $10 а стало $4,5).

Накопились некоторые данные о точности PZEM004T, можно сравнить с реальным дисковым счетчиком. Как видно, в основном, PZEM004T чуть завышает месячные показания. Возможно, это связано с погрешностью подсчета реактивной мощности (дисковый счетчик чуть загрубляет показания), либо при малых потреблениях (единицы Ватт) PZEM004T ведет себя получше. Без контрольных СИТ сложно что-то предположить.

<table border="2">
    <tr>
        <td>PZEM004T (кВт*ч)</td>
        <td>Реальный счетчик (кВт*ч)</td>
    </tr>
    <tr>
        <td>196</td>
        <td>192</td>
    </tr>
    <tr>
        <td>215</td>
        <td>212</td>
    </tr>
    <tr>
        <td>195</td>
        <td>191</td>
    </tr>
    <tr>
        <td>131</td>
        <td>131</td>
    </tr>
    <tr>
        <td>121</td>
        <td>120</td>
    </tr>
    <tr>
        <td bgcolor="#fe0000">149</td>
        <td>157</td>
    </tr>
    <tr>
        <td>275</td>
        <td>275</td>
    </tr>
    <tr>
        <td>169</td>
        <td>169</td>
    </tr>
    <tr>
        <td>160</td>
        <td>159</td>
    </tr>
    <tr>
        <td>127</td>
        <td>127</td>
    </tr>
    <tr>
        <td>135</td>
        <td>133</td>
    </tr>
    <tr>
        <td>102</td>
        <td>100</td>
    </tr>
    <tr>
        <td>173</td>
        <td>170</td>
    </tr>
    <tr>
        <td>253</td>
        <td>249</td>
    </tr>
</table>

Work in progress...

![visitors](https://visitor-badge.glitch.me/badge?page_id=VladimirBakum.esp8266.powermeter&left_color=green&right_color=red)

